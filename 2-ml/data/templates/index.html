<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    >
    <script>
      window.onload = () => {
        const resultCard = document.getElementById("resultCard");
        const errorCard = document.getElementById("errorCard");

        document.getElementById("predictionForm").addEventListener(
          "submit",
          async function (event) {
            event.preventDefault();

            resultCard.classList.add("d-none");
            errorCard.classList.add("d-none");

            const form = event.target;
            const dataToSend = {};

            // Sammelt alle 12 Input-Werte in einem Dictionary {feature_name: value}
            // Beachte: Select-Felder geben den String-Value zurück, Number-Felder den String-Wert der Zahl.
            const allInputs = form.querySelectorAll("input, select");
            allInputs.forEach((input) => {
              dataToSend[input.name] = input.value;
            });

            console.log("Sende Daten:", dataToSend);

            try {
              const response = await fetch("/predictions", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(dataToSend),
              });

              if (response.ok) {
                const result = await response.json();

                // Erfolgreiche Vorhersage
                document.getElementById("scoreResult").textContent =
                  result.final_exam_score;
                document.getElementById("passResult").textContent =
                  result.passed_exam_label;

                // Style für das Bestehen anpassen
                const passResultSpan = document.getElementById(
                  "passResult",
                );
                passResultSpan.className = result.passed_exam_raw === 1
                  ? "fw-bold text-success"
                  : "fw-bold text-danger";

                resultCard.classList.remove("d-none");
              } else {
                // Fehler vom Server
                document.getElementById("errorMessage").textContent =
                  result.error ||
                  "Unbekannter Fehler bei der Serververarbeitung.";
                errorCard.classList.remove("d-none");
              }
            } catch (error) {
              // Netzwerkfehler
              console.error("Fetch Error:", error);
              document.getElementById("errorMessage").textContent =
                `Netzwerkfehler: Server nicht erreichbar. (${error.message})`;
              errorCard.classList.remove("d-none");
            }
          },
        );
      };
    </script>
    <title>Exam Performance Prediction</title>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Python Prüfungsleistung Vorhersage</h1>
      <p class="lead">
        Geben Sie Ihre Lernmetriken ein, um die Abschlussnote und das Bestehen
        vorherzusagen.
      </p>

      <form id="predictionForm" class="row g-3">
        {% for feature in raw_features %}
        <div class="col-md-4">
          <label for="{{ feature }}" class="form-label"
          >{{ feature | replace('_', ' ') | title }}</label>

          {% if feature in categorical_features %}
          <select
            class="form-select"
            id="{{ feature }}"
            name="{{ feature }}"
            required
          >
            {% if feature == 'country' %}
            <option value="Germany">Germany</option>
            <option value="USA" selected>USA</option>
            <option value="India">India</option>
            <option value="China">China</option>
            <option value="Brazil">Brazil</option>
            <option value="Other">Other</option>
            {% elif feature == 'prior_programming_experience' %}
            <option value="Yes" selected>Ja</option>
            <option value="No">Nein</option>
            {% elif feature == 'uses_kaggle' or feature ==
            'participates_in_discussion_forums' %}
            <option value="Yes" selected>Ja</option>
            <option value="No">Nein</option>
            {% else %}
            <option value="">Wählen Sie...</option>
            {% endif %}
          </select>
          {% else %}
          <input
            type="number"
            step="any"
            class="form-control"
            id="{{ feature }}"
            name="{{ feature }}"
            required
          >
          {% endif %}
        </div>
        {% endfor %}

        <div class="col-12 mt-4">
          <button type="submit" class="btn btn-primary btn-lg">
            Vorhersage starten
          </button>
        </div>
      </form>

      <div id="resultCard" class="card mt-5 d-none">
        <div class="card-header bg-success text-white">
          Ergebnis der Vorhersage
        </div>
        <div class="card-body">
          <h5 class="card-title">
            Erreichte Punktzahl (prognostiziert): <span
              id="scoreResult"
              class="fw-bold"
            ></span>%
          </h5>
          <h5 class="card-title">
            Prüfung bestanden (prognostiziert): <span
              id="passResult"
              class="fw-bold"
            ></span>
          </h5>
        </div>
      </div>

      <div id="errorCard" class="card mt-5 d-none border-danger">
        <div class="card-header bg-danger text-white">
          Fehler
        </div>
        <div class="card-body">
          <p id="errorMessage" class="card-text text-danger"></p>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
